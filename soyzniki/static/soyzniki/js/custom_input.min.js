var INPUTS_COUNT = 4;/*колличество полей*/
var box = {/*список полей*/
    country: document.getElementById('country'),    
    region: document.getElementById('region'),    
    district: document.getElementById('district'),    
    city: document.getElementById('city'),
    0: this.country,
    1: this.region,
    2: this.district,
    3: this.city,
}
var relation = {/*список зависимостей*/
    country: new Array('region', 'district', 'city'),    
    region: new Array('district', 'city'),    
    district: new Array('city'),
}
var addiction = {/*список зависимых полей*/
    region: 'country',    
    district: 'region',    
    city: 'district',
}
/*
скрипт для кастомизации полей ввода 
страны, области, района, населенного пункта
*/
$(window).ready(function(){
    initial();    
    var csrftoken = $.cookie('csrftoken');
    function csrfSafeMethod(method) {
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }    
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });
});
/*
инициализация полей, добавление
дополнительных элементов
*/
function initial(){
    for(i=0; i<INPUTS_COUNT; i++){
        var clean = document.createElement('span');
        var boxes = document.createElement('div');
        clean.className = 'clean';
        clean.innerHTML = 'X';
        clean.style.cursor = 'pointer';
        boxes.className = 'boxes';
        boxes.style.position = 'absolute';
        boxes.style.width = box.country.clientWidth + 3 + 'px';
        boxes.style.maxHeight = '200px';
        boxes.style.overflowY = 'auto';
        boxes.style.background = '#ffffff';
        boxes.style.zIndex = '10';
        boxes.style.display = 'none';
        box[i].parentElement.appendChild(clean);
        box[i].parentElement.appendChild(boxes);
    }
}
/*
очистка зависимых полей при клике по
крестику возле поля ввода
*/
$('form li').click(function(event){
    var element_name;    
    var input; 
    var hidden_input;
    var relate;    
    var relate_input;
    var related_hidden_input 
    if(event.target.className == 'clean'){
        element_name = event.target.parentElement.children[1].id;
        input = document.getElementById(element_name);
        input.value = '';
        hidden_input = document.getElementById(input.id + '_id');
        hidden_input.value = ''
        input.blur();
        if(element_name in relation){
            relate = relation[element_name];
            for(i=0; i<relate.length; i++){
                relate_input = document.getElementById(relate[i]);
                relate_input.value = '';
                related_hidden_input = document.getElementById(relate[i] + '_id');
                related_hidden_input.value = ''
            }
        }
    }    
});
/*
фокус поля
*/
$('.custom_input').focus(function(event){
    if(event.target.id in box){
        load_data(event.target.id, event.target.value);
    }
});
/*
ввод данных
*/
$('.custom_input').keypress(function(event){
    load_data(event.target.id, event.target.value);
});
/*
загрузка и обработка загруженных данных данных
*/
function load_data(element, val=''){
    var addiction_element;
    var addiction_value;
    if(element in addiction){
        addiction_element = document.getElementById(addiction[element]);
        addiction_value = addiction_element.value;
    }    
    var list = new Array();
    $.ajax({
        url: '/async/load_list',
        type: 'POST',
        data: {
            addiction_element: addiction[element],
            addiction_value: addiction_value,
            value: val
        }
    }).done(function(data){
        var arr = JSON.parse(data);
        var active_input = document.getElementById(element);
        var active_input_hidden = document.getElementById(`${element}_id`);
        var block_list = active_input.parentElement.children[3];
        if(block_list.children.length > 0){
            block_list.children[0].remove();
        }
        block_list.style.display = 'block';
        block_list.appendChild(add(arr));
        $('li.name').click(function(event){
            active_input.value = event.target.innerHTML;
            active_input.blur();
            if (active_input_hidden !== null){
                active_input_hidden.value = event.target.id;                
            }
            block_list.style.display = 'none';
            var relate;
            var relate_input;   
            if(element in relation){
                relate = relation[element];
                for(i=0; i<relate.length; i++){
                    relate_input = document.getElementById(relate[i]);
                    relate_input.value = '';
                }
            }
        });
        $(document).click(function(event){
            if((event.target.className != 'name') &&
                (event.target != active_input)){
                active_input.blur();
                block_list.style.display = 'none';
            }
    });   
    });
}
/*
создание объектов html из загруженных данных
*/
function add(arr){
    var obj = document.createElement('ul');
    if(arr.length == 0){
        var elem = document.createElement('li');
        elem.className = 'error';
        elem.innerHTML = 'Совпадений не найдено';
        obj.appendChild(elem);
        return obj;
    }
    for(i=0; i<arr.length; i++){
        var elem = document.createElement('li');
        elem.className = 'name';
        elem.innerHTML = arr[i]['name'];
        elem.id = arr[i]['id'];
        elem.style.cursor = 'pointer';
        obj.appendChild(elem);
    }
    return obj;
}
